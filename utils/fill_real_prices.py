import pandas as pd
import os
import glob
import random
import sys

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì„¤ì •
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
try:
    from config.settings import settings
    DATA_RAW_DIR = settings.DATA_RAW
except ImportError:
    DATA_RAW_DIR = os.path.join(os.path.dirname(__file__), '..', 'data_raw')

# 1. [ê³ ì • ê°€ê²©] ì‹¤ì œ ì¡°ì‚¬ëœ í‘œì¤€ ê°€ê²© (ë³€ë™ ì—†ìŒ)
PRICE_MAP = {
    # --- ë§˜ìŠ¤í„°ì¹˜ ---
    'ì‹¸ì´ë²„ê±°': 4600, 'ì‹¸ì´í”Œë ‰ìŠ¤ë²„ê±°': 7700, 'ì¸í¬ë ˆë”ë¸”ë²„ê±°': 5700, 'ì–¸ë¹Œë¦¬ë²„ë¸”ë²„ê±°': 6200,
    'ë”¥ì¹˜ì¦ˆì‹¸ì´ë²„ê±°': 5100, 'í™”ì´íŠ¸ê°ˆë¦­ì‹¸ì´ë²„ê±°': 5200, 'ë¶ˆê³ ê¸°ë²„ê±°': 3900, 
    'ì¼€ì´ì¤€ì–‘ë…ê°ì': 2000, 'ë°”ì‚­í¬ë¦¼ì¹˜ì¦ˆë³¼': 3700, 'ì½œë¼': 1600,
    
    # --- ë²„ê±°í‚¹ ---
    'ì™€í¼': 7100, 'ì¹˜ì¦ˆì™€í¼': 7700, 'ê°ˆë¦­ë¶ˆê³ ê¸°ì™€í¼': 7400, 'ì½°íŠ¸ë¡œì¹˜ì¦ˆì™€í¼': 7900,
    'í†µìƒˆìš°ì™€í¼': 7900, 'ëª¬ìŠ¤í„°ì™€í¼': 9300, 'ì™€í¼ì£¼ë‹ˆì–´': 4700, 'ë¶ˆê³ ê¸°ì™€í¼ì£¼ë‹ˆì–´': 4700,
    'ë¡±ì¹˜í‚¨ë²„ê±°': 4700, 'í”„ë Œì¹˜í”„ë¼ì´': 2100, 'ë„ˆê²Ÿí‚¹': 2200, 'ì½”ì¹´ì½œë¼': 2000,
    
    # --- ë¡¯ë°ë¦¬ì•„ ---
    'ë°ë¦¬ë²„ê±°': 3300, 'ì¹˜í‚¨ë²„ê±°': 4000, 'ë¦¬ì•„ë¶ˆê³ ê¸°': 4700, 'ìƒˆìš°ë²„ê±°': 4700, 'ë¦¬ì•„ìƒˆìš°': 4700,
    'í•«í¬ë¦¬ìŠ¤í”¼ë²„ê±°': 5900, 'í´ë˜ì‹ì¹˜ì¦ˆë²„ê±°': 5200, 'í•œìš°ë¶ˆê³ ê¸°': 8400, 'ëª¨ì§œë ë¼ì¸ë”ë²„ê±°': 7400,
    'ì „ì£¼ë¹„ë¹”ë¼ì´ìŠ¤ë²„ê±°': 6900, 'í¬í…Œì´í† ': 1800, 'ì¹˜ì¦ˆìŠ¤í‹±': 2400,
    
    # --- ë§¥ë„ë‚ ë“œ ---
    'ë¹…ë§¥': 5500, 'ë§¥ìŠ¤íŒŒì´ì‹œìƒí•˜ì´ë²„ê±°': 5500, '1955ë²„ê±°': 6400, 'ë² ì´ì»¨í† ë§ˆí† ë””ëŸ­ìŠ¤': 5800,
    'ë§¥ì¹˜í‚¨': 3500, 'ë¶ˆê³ ê¸°ë²„ê±°': 3100, 'ì¹˜ì¦ˆë²„ê±°': 2700, 'í–„ë²„ê±°': 2500, 'ìŠˆìŠˆë²„ê±°': 4700,
    'ìŠˆë¹„ë²„ê±°': 5800, 'ë”ë¸”ì¿¼í„°íŒŒìš´ë”ì¹˜ì¦ˆ': 7400, 'ë§¥ë„ˆê²Ÿ': 2600, 'í›„ë Œì¹˜í›„ë¼ì´': 2200,
    
    # --- ì„œë¸Œì›¨ì´ (15cm ë‹¨í’ˆ ê¸°ì¤€) ---
    'ì´íƒˆë¦¬ì•ˆë¹„ì— í‹°': 6700, 'ì—ê·¸ë§ˆìš”': 5500, 'ìŠ¤í…Œì´í¬ì•¤ì¹˜ì¦ˆ': 7900, 'ì¨ë¸Œì›¨ì´í´ëŸ½': 7100,
    'ë¡œìŠ¤íŠ¸ì¹˜í‚¨': 7300, 'ë¡œí‹°ì„¸ë¦¬ë°”ë¹„íì¹˜í‚¨': 7300, 'í„°í‚¤': 6200, 'ë¹„ì—˜í‹°': 6600, 
    'ì°¸ì¹˜': 5800, 'ë² ì§€': 4900, 'ì‰¬ë¦¼í”„': 7600, 'í’€ë“œí¬í¬': 7200,
    
    # --- ìƒëŸ¬ë”” ---
    'íƒ„ë‹¨ì§€ìƒëŸ¬ë””': 8900, 'ì—°ì–´ìƒëŸ¬ë””': 10900, 'ë¡œìŠ¤íŠ¸ë‹­ë‹¤ë¦¬ì‚´ìƒëŸ¬ë””': 9900, 'ì½¥ìƒëŸ¬ë””': 7900,
    'ìš°ì‚¼ê²¹ë©”ë°€ë©´ìƒëŸ¬ë””': 9300, 'ì¹ ë¦¬ë² ì´ì»¨ì›œë³¼': 7900, 'ìš°ì‚¼ê²¹ì›œë³¼': 8900, 'í• ë¼í”¼ë‡¨ì¹˜í‚¨ì›œë³¼': 8500,
    'ì¹˜í‚¨í† ë§ˆí† ìƒŒë“œìœ„ì¹˜': 6900, 'ë§¥ì‹œì¹¸ë©': 7200, 'ì‹œì €ì¹˜í‚¨ë©': 6900, 'í¬ë¦¬ë¯¸ì—°ì–´ë©': 8900,
    
    # --- í”„ë ˆí¼ìŠ¤ ---
    'ì¹˜í‚¨í”Œë ˆì´íŠ¸': 9900, 'í¬í¬í”Œë ˆì´íŠ¸': 10900, 'ë¹„í”„í”Œë ˆì´íŠ¸': 12900,
    'ì¹˜í‚¨ë°ë¦¬ì•¼ë¼ë®ë°¥': 9900, 'í¬í¬ëª…ì´ë‚˜ë¬¼ë®ë°¥': 10900, 'ë¹„í”„ì™€ì‚¬ë¹„ë®ë°¥': 12900,
    'ì¹˜í‚¨ìƒëŸ¬ë“œíŒŒìŠ¤íƒ€': 9900, 'ë¹„í”„ìƒëŸ¬ë“œíŒŒìŠ¤íƒ€': 12900
}

# 2. [ì¶”ì • ê°€ê²© ê¸°ì¤€] ë§¤í•‘ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•  ê¸°ì¤€ ê°€ê²©
DEFAULT_PRICES = {
    'Burger': 6500, 'Set': 9500, 'Side': 2500, 'Beverage': 2000,
    'Salad': 9500, 'Sandwich': 7500, 'Chicken': 15000, 'Default': 5000
}

def update_real_prices():
    files = glob.glob(os.path.join(DATA_RAW_DIR, "*_products.csv"))
    
    if not files:
        print("âŒ ì˜¤ë¥˜: ë°ì´í„° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    print(f"ğŸ“Š ê°€ê²© ë°ì´í„° ë³´ì • ì‹œì‘ (ëœë¤ ë³€ë™ì„± ì ìš© Â±500ì›)")

    for file in files:
        df = pd.read_csv(file)
        
        def get_real_price(row):
            # ì´ë¯¸ ìœ íš¨í•œ ê°€ê²©ì´ ìˆë‹¤ë©´ ìœ ì§€ (ë‹¨, 100ì› ë‹¨ìœ„ê°€ ì•„ë‹ˆë©´ ë°˜ì˜¬ë¦¼)
            current_price = row.get('price', 0)
            if current_price > 100: 
                return int(round(current_price, -2))
            
            name = str(row['menu_name']).replace(' ', '').replace('Â®', '')
            
            # 1. ì •í™•í•œ ë§¤í•‘ (ê³ ì • ê°€ê²©)
            for key, price in PRICE_MAP.items():
                if key in name or name in key:
                    if ('ì„¸íŠ¸' in name) or ('ì½¤ë³´' in name):
                        return price + 3000
                    return price
            
            # 2. ì¹´í…Œê³ ë¦¬ ì¶”ì • + ëœë¤ ë³€ë™ì„± ì¶”ê°€ (100ì› ë‹¨ìœ„)
            category = str(row.get('category', 'Default'))
            base_price = DEFAULT_PRICES['Default']

            if 'ì„¸íŠ¸' in name or 'ì½¤ë³´' in name: base_price = DEFAULT_PRICES['Set']
            elif 'ë²„ê±°' in name or 'ì™€í¼' in name: base_price = DEFAULT_PRICES['Burger']
            elif 'ìƒëŸ¬ë“œ' in category or 'ë³¼' in category: base_price = DEFAULT_PRICES['Salad']
            elif 'ìƒŒë“œìœ„ì¹˜' in category or 'ë©' in category: base_price = DEFAULT_PRICES['Sandwich']
            elif 'ì‚¬ì´ë“œ' in category or 'ê°ì' in name or 'ë„ˆê²Ÿ' in name: base_price = DEFAULT_PRICES['Side']
            elif 'ìŒë£Œ' in category or 'ì½œë¼' in name or 'ì»¤í”¼' in name: base_price = DEFAULT_PRICES['Beverage']

            # ëœë¤ ë³€ë™ì„±: -500ì› ~ +500ì› (100ì› ë‹¨ìœ„)
            variation = random.randint(-5, 5) * 100
            final_price = base_price + variation
            
            return max(1000, final_price) # ìµœì†Œ 1000ì› ë³´ì¥

        df['price'] = df.apply(get_real_price, axis=1)
        
        df.to_csv(file, index=False, encoding='utf-8-sig')
        print(f"   âœ… {os.path.basename(file)} ì™„ë£Œ")

if __name__ == "__main__":
    update_real_prices()